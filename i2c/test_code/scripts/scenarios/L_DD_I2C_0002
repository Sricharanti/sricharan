################################################################################
# Scenario: L_DD_12C_0002
# Author  : Nishanth Menon
# Date    : Tue Jun 13 12:23:42 CDT 2006
# Description: 
# Standard Speed Tests
# 1.Transfer (send and receive) to a device.
# 2.Transfer (send and receive) to multiple device simultaneously.
# 3.Test error recovery by attempting transfer to a non-existent device
# 4.Attempt transfer cancellation by sending user cancellation signal while transfer is in progress.
# 5.Check for change in interrupt entries while transfers take place to prove that the driver uses interrupt mode.
# 6.Attempt power management . scaling and suspend/resume while transfer is active
################################################################################

# Begin L_DD_I2C_0002

# Initial Setup
# setup export I2C_SPEED0=$I2C_STD; export I2C_SPEED1=$I2C_STD; mod.sh insert && exit 0 || exit 1

# Single device, read/write test -sim r/w
0001 set -x; testrw.sh $I2C_TEST_BUS1 $I2C_TEST_B1_D1_ADD $I2C_TEST_B1_D1_OFF && exit 0 || exit 1

# Test on same bus two different devices
0002a set -x; (testrw.sh $I2C_TEST_BUS1 $I2C_TEST_B1_D1_ADD $I2C_TEST_B1_D1_OFF &) && testrw.sh $I2C_TEST_BUS1 $I2C_TEST_B1_D2_ADD $I2C_TEST_B1_D2_OFF && wait.sh testrw.sh 1 && exit 0||exit 1

# Setup for bus2.. cleanup the register before playing with it.. ignore the result
# 002b_setup set -x; i2cset -y $I2C_TEST_BUS2 $I2C_TEST_B2_D1_ADD $I2C_TEST_B2_D1_OFF 0xFF && exit 0 || exit 0 

# Test with the next bus also with current bus.. three transfers at once..
# 0002b set -x; (testrw.sh $I2C_TEST_BUS1 $I2C_TEST_B1_D1_ADD $I2C_TEST_B1_D1_OFF &) && ( testrw.sh $I2C_TEST_BUS1 $I2C_TEST_B1_D2_ADD $I2C_TEST_B1_D2_OFF &) && export count=7 && testrw.sh $I2C_TEST_BUS2 $I2C_TEST_B2_D1_ADD $I2C_TEST_B2_D1_ON && wait.sh testrw.sh 1 && exit 0 || exit 1

# Non Existant device Test - test against two busses simultaneously
0003 set -x; (testrw.sh $I2C_TEST_BUS1 $I2C_TEST_B1_D1_NODEV $I2C_TEST_B1_D1_OFF &) && testrw.sh $I2C_TEST_BUS2 $I2C_TEST_B2_D1_NODEV $I2C_TEST_B2_D1_ON && wait.sh testrw.sh 1 && exit 1 || exit 0

# Test cancellation of transfers - read
0004a set -x; (i2cdump -y  $I2C_TEST_BUS1 $I2C_TEST_B1_D1_ADD b &);(i2cdump -y  $I2C_TEST_BUS1 $I2C_TEST_B1_D2_ADD b &) && killall i2cdump && exit 0 || exit 1
0004b set -x; (i2cset -y  $I2C_TEST_BUS1 $I2C_TEST_B1_D1_ADD $I2C_TEST_B1_D1_OFF 0x12 &) && killall i2cset && exit 0 || exit 1

# Check for interrupts in bus 1 and 2 after all the above transfers, they should have changed
0005 set -x; for i in 1 2 ; do K=`cat /proc/interrupts | grep $INTERRUPT_PREFIX | sed -e "s/  */ /g"|cut -d ' ' -f3`; if [ "$K" = "0" ]; then exit 1; fi; done; exit 0

# Clean up
# cleanup mod.sh remove && exit 0 || exit 1

# End L_DD_I2C_0002
