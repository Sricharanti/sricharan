###############################################################################
# Scenario: L_DD_MMC_0004_0003
# Author  : Misael Lopez Cruz
# Date    : September 20, 2006
###############################################################################

# Begin L_DD_MMC_0004_0003

# Clean up
01  set -x; rm -rf $MMC_MOUNT_POINT_1 $MMC_MOUNT_POINT_2; exit 0
02  set -x; mkdir $MMC_MOUNT_POINT_1 && mkdir $MMC_MOUNT_POINT_2; exit 0

# Creating, verifying and printing partitions
03  set -x; echo -e "n\n p\n 1\n $MMC_DEVICE_SECTOR_START\n $MMC_DEVICE_SECTOR_MIDDLE\n n\n p\n 2\n $(echo $MMC_DEVICE_SECTOR_MIDDLE+1|bc)\n $MMC_DEVICE_SECTOR_END\n w\n" | fdisk $MMC_ROOT_ENTRY && exit 0 || exit 1
04  set -x; cat $PROCFS_PARTITIONS | grep $MMC_PARTITION_NAME1 && exit 0 || exit 1
05  set -x; cat $PROCFS_PARTITIONS | grep $MMC_PARTITION_NAME2 && exit 0 || exit 1
06  set -x; echo -e "p\n w\n" | fdisk $MMC_ROOT_ENTRY && exit 0 || exit 1

# DOS: Formatting, mounting, verifying and unmounting partition
07  set -x; sleep 1 && $TESTBIN/mkdosfs $MMC_PARTITION_ENTRY1 && exit 0 || exit 1
08  set -x; mount -t vfat $MMC_PARTITION_ENTRY1 $MMC_MOUNT_POINT_1 && exit 0 || exit 1
09  set -x; mount | grep $MMC_PARTITION_ENTRY1 | grep "vfat" && exit 0 || exit 1

# EXT2: Formatting, mounting, verifying and unmounting partition
10  set -x; sleep 1 && $TESTBIN/mke2fs $MMC_PARTITION_ENTRY2 && exit 0 || exit 1
11  set -x; mount -t ext2 $MMC_PARTITION_ENTRY2 $MMC_MOUNT_POINT_2 && exit 0 || exit 1
12  set -x; mount | grep $MMC_PARTITION_ENTRY2 | grep "ext2" && exit 0 || exit 1

# Copying and verifying content
13  set -x; (cp $TESTROOT/$FILE_SIZE_BIG $MMC_MOUNT_POINT_1 &) && (cp $TESTROOT/$FILE_SIZE_BIG $MMC_MOUNT_POINT_2 &) && sync && exit 0 || exit 1
14  set -x; test -e $MMC_MOUNT_POINT_1/$FILE_SIZE_BIG && exit 0 || exit 1
15  set -x; test -e $MMC_MOUNT_POINT_2/$FILE_SIZE_BIG && exit 0 || exit 1

# Unmounting partitions
16  set -x; umount $MMC_MOUNT_POINT_1 && sync && exit 0 || exit 1
17  set -x; umount $MMC_MOUNT_POINT_2 && sync && exit 0 || exit 1
18  set -x; test -e $MMC_MOUNT_POINT_1/$FILE_SIZE_BIG && exit 1 || exit 0
19  set -x; test -e $MMC_MOUNT_POINT_2/$FILE_SIZE_BIG && exit 1 || exit 0

# Mounting and verifying again partitions
20  set -x; mount -t vfat $MMC_PARTITION_ENTRY1 $MMC_MOUNT_POINT_1 && exit 0 || exit 1
21  set -x; mount | grep $MMC_PARTITION_ENTRY1 | grep "vfat" && exit 0 || exit 1
22  set -x; mount -t ext2 $MMC_PARTITION_ENTRY2 $MMC_MOUNT_POINT_2 && exit 0 || exit 1
23  set -x; mount | grep $MMC_PARTITION_ENTRY2 | grep "ext2" && exit 0 || exit 1

# Verifying content
24  set -x; test -e $MMC_MOUNT_POINT_1/$FILE_SIZE_BIG && exit 0 || exit 1
25  set -x; test -e $MMC_MOUNT_POINT_2/$FILE_SIZE_BIG && exit 0 || exit 1

# Unmounting partitions
26  set -x; umount $MMC_MOUNT_POINT_1 && sync && exit 0 || exit 1
27  set -x; umount $MMC_MOUNT_POINT_2 && sync && exit 0 || exit 1
28  set -x; test -e $MMC_MOUNT_POINT_1/$FILE_SIZE_BIG && exit 1 || exit 0
29  set -x; test -e $MMC_MOUNT_POINT_2/$FILE_SIZE_BIG && exit 1 || exit 0

# Removing Partitions
30  set -x; echo -e "d\n 1\n d\n w\n" | fdisk $MMC_ROOT_ENTRY && exit 0 || exit 1

# Verifying partitions
31  set -x; cat $PROCFS_PARTITIONS | grep $MMC_PARTITION_NAME1 && exit 1 || exit 0
32  set -x; cat $PROCFS_PARTITIONS | grep $MMC_PARTITION_NAME2 && exit 1 || exit 0

# End L_DD_MMC_0004_0003
