###################################################################################################################
# Scenario: L_DD_MMC_0007D
# Author  : Misael Lopez Cruz
# Date    : March 29, 2007
# Description: Test that driver supports hotplug features
###################################################################################################################

# Begin L_DD_MMC_0007D

setup_1	echo -e "n\n p\n 1\n $START_SECTOR_DEV1\n $END_SECTOR_DEV1\n w\n" | fdisk $ROOT_ENTRY_DEV1 && $TESTBIN/mke2fs $PARTITION1_ENTRY_DEV1 && echo "Remove MMC card from slot 1" && $UTILBIN/waitkey && exit 0 || exit 1
setup_2	echo -e "n\n p\n 1\n $START_SECTOR_DEV2\n $END_SECTOR_DEV2\n w\n" | fdisk $ROOT_ENTRY_DEV2 && $TESTBIN/mke2fs $PARTITION1_ENTRY_DEV2 && echo "Remove MMC card from slot 2" && $UTILBIN/waitkey && exit 0 || exit 1

0001_1a	echo "Insert MMC card into slot 1 (To ensure that partition is mounted, insert the card twice)" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT1 && exit 0 || exit 1
0001_2a	echo "Insert MMC card into slot 2 (To ensure that partition is mounted, insert the card twice)" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT2 && exit 0 || exit 1
0001_1b	echo "Remove MMC card from slot 1" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT1 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1
0001_2b	echo "Remove MMC card from slot 2" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT2 && exit 2 || echo "Unmounted successfully") && exit 0 || exit 1

0002_1a	echo "Insert MMC card into slot 1" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT1 && exit 0 || exit 1
0002_2a	echo "Insert MMC card into slot 2" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT2 && exit 0 || exit 1
0002_1b	echo "Remove MMC card from slot 1" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT1 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1
0002_2b	echo "Remove MMC card from slot 2" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT2 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1

0003_1a echo "Insert MMC card into slot 1" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT1 && exit 0 || exit 1
0003_2a echo "Insert MMC card into slot 2" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT2 && exit 0 || exit 1
0003_1b echo "Remove MMC card from slot 1" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT1 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1
0003_2b echo "Remove MMC card from slot 2" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT2 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1

0004_1a	echo "Insert MMC card into slot 1" && sleep 1 &&  $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT1 && cp $TESTROOT/$BIG_FILE $DEFAULT_MOUNT_POINT1 && sync && exit 0 || exit 1
0004_2a	echo "Insert MMC card into slot 2" && sleep 1 &&  $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT2 && cp $TESTROOT/$BIG_FILE $DEFAULT_MOUNT_POINT2 && sync && exit 0 || exit 1
0004_1b	echo "Remove MMC card from slot 1" && sleep 1 && $UTILBIN/waitkey && exit 0 || exit 1
0004_2b	echo "Remove MMC card from slot 2" && sleep 1 && $UTILBIN/waitkey && exit 0 || exit 1
0004_1c	echo "Insert MMC card into slot 1" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT1 && cmp $TESTROOT/$BIG_FILE $DEFAULT_MOUNT_POINT1/$BIG_FILE && rm $DEFAULT_MOUNT_POINT1/$BIG_FILE && sync && exit 0 || exit 1
0004_2c	echo "Insert MMC card into slot 2" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT2 && cmp $TESTROOT/$BIG_FILE $DEFAULT_MOUNT_POINT2/$BIG_FILE && rm $DEFAULT_MOUNT_POINT2/$BIG_FILE && sync && exit 0 || exit 1
0004_1d	echo "Remove MMC card from slot 1" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT1 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1
0004_2d	echo "Remove MMC card from slot 2" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT2 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1

0005_1a echo "Insert MMC card into slot 1" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT1 && exit 0 || exit 1
0005_2a echo "Insert MMC card into slot 2" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT2 && exit 0 || exit 1
0005_1b (cp $TESTROOT/$BIG_FILE $DEFAULT_MOUNT_POINT1 &) && echo "Remove MMC card from slot 1 (Several IO errors are expected!)" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT1 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1
0005_2b (cp $TESTROOT/$BIG_FILE $DEFAULT_MOUNT_POINT2 &) && echo "Remove MMC card from slot 2 (Several IO errors are expected!)" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT2 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1
0005_1c echo "Insert MMC card into slot 1" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT1 && exit 0 || exit 1
0005_2c echo "Insert MMC card into slot 2" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT2 && exit 0 || exit 1
0005_1d echo "Remove MMC card from slot 1" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT1 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1
0005_2d echo "Remove MMC card from slot 2" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT2 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1

0006_1	echo $HOTPLUG_DISABLE > $HOTPLUG_DEV1 && echo "Insert and remove MMC card into slot 1" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT1 && exit 1 || exit 0
0006_2	echo $HOTPLUG_DISABLE > $HOTPLUG_DEV2 && echo "Insert and remove MMC card into slot 2" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT2 && exit 1 || exit 0

0007_1a	echo $HOTPLUG_ENABLE > $HOTPLUG_DEV1 && echo "Insert MMC card into slot 1" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT1 && exit 0 || exit 1
0007_2a	echo $HOTPLUG_ENABLE > $HOTPLUG_DEV2 && echo "Insert MMC card into slot 2" && sleep 1 && $UTILBIN/waitkey && df | grep $DEFAULT_MOUNT_POINT2 && exit 0 || exit 1
0007_1b	echo "Remove MMC card from slot 1" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT1 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1
0007_2b	echo "Remove MMC card from slot 2" && sleep 1 && $UTILBIN/waitkey && (df | grep $DEFAULT_MOUNT_POINT2 && exit 1 || echo "Unmounted successfully") && exit 0 || exit 1

cleanup_1 echo "Insert MMC card into slot 1" && sleep 1 && $UTILBIN/waitkey && umount $DEFAULT_MOUNT_POINT1 && echo -e "d\n w\n" | fdisk $ROOT_ENTRY_DEV1 && exit 0 || exit 1
cleanup_2 echo "Insert MMC card into slot 2" && sleep 1 && $UTILBIN/waitkey && umount $DEFAULT_MOUNT_POINT2 && echo -e "d\n w\n" | fdisk $ROOT_ENTRY_DEV2 && exit 0 || exit 1

# End L_DD_MMC_0007D
