################################################################################
# Scenario: L_DD_USBEHCI_0005_1
# Author  : Axel Castaneda Gonzalez
# Date    : September 20, 2006
# Description: Test if the Host can use USB Mass Storage devices on Bulk data
#	transfers.
# ChangeLog:
#	6 Feb 2009 - Diego Zavala Trujillo - Adapting scenario from Host to EHCI.
#################################################################################

foo	echo L_DD_USBEHCI_0005_1

1  set -x; insmod $MODULE_PATH/ehci-hcd.ko  &&  echo -e "\n\n\t Testing Bulk Data Transfers with a USB Mass Storage. \n\n" &&  sleep $DELAY1  &&  echo "0" > $LOGBASE/log.panresult; exit 0 || echo -e "\n\n\t ERROR1 - No module found. \n\n"; echo "1" > $LOGBASE/log.panresult; exit 1

1  if [ `cat $LOGBASE/log.panresult` = 0 ]; then echo on > $ECHI_LEVEL  &&  echo -e "\n\n\t Turning on the echi device \n\n"  &&  exit 0 || exit 1; else echo -e "\n\n\t ERROR1 - Could not run this test because the module has not been inserted. \n\n"; exit 1; fi

### Loading modules

2  if [ `cat $LOGBASE/log.panresult` = 0 ]; then insmod $MODULE_PATH/usb-storage.ko  &&  echo -e "\n\n\t Connect USB Mass Storage Device to USB port. \n\n"  && sleep $DELAY3  &&  exit 0 || exit 1; else echo -e "\n\n\t ERROR1 - Could not run this test because the module has not been inserted. \n\n"; exit 1; fi

# Make the device nodes if required.


#   && cat  /proc/bus/usb/devices | grep 'stor'
7  set -x; if [ $USB_DRIVER = "MENTOR" ] ; then  echo 'F' > $PROC_INT && sleep $DELAY2 ; fi  && cat $ENUM_COMM | grep 'stor' && exit 0 || exit 1

#8  mknod /dev/sda b 8 0
#   && mknod /dev/sda1 b 8 1
8  set -x; mknod /dev/sda b 8 0 && mknod /dev/sda1 b 8 1 && exit 0 || exit 0

#Mount the partition and test it by writing/reading a file

#9   cat /proc/scsi/scsi
#    && cat /proc/scsi/usb-storage/0
#    && mkdir -p /testsuites/usb_ehci/scripts/misc/mass_storage
#    && dd if=/dev/zero of=/testsuites/usb_ehci/scripts/misc/6m bs=1M count=5
9   set -x; cat /proc/scsi/scsi &&  cat /proc/scsi/usb-storage/0 && mkdir -p ${MASS_DIRECTORY} &&  dd if=/dev/zero of=${MISC_PATH}/$MASS_FILE bs=1M count=5 && exit 0 || exit 1

#10  ls /dev/sd*um
#    mount  /dev/sda1 /testsuites/usb_ehci/scripts/misc/mass_storage
10  set -x; ls /dev/sd* && mount  /dev/sda1 $MASS_DIRECTORY  && echo -e '\n\n\t USB mass storage device mounted properly \n\n' && exit 0 || exit 1

#11  cp /testsuites/usb_ehci/scripts/misc/6m /testsuites/usb_ehci/scripts/misc/mass_storage
11  set -x; cp ${MISC_PATH}/$MASS_FILE $MASS_DIRECTORY/ && exit 0 || exit 1

#12  cmp /testsuites/usb_ehci/scripts/misc/6m /testsuites/usb_ehci/scripts/misc/mass_storage
12  set -x; cmp  ${MISC_PATH}/$MASS_FILE $MASS_DIRECTORY/$MASS_FILE && echo -e '\n\n\t Compare test succeeded  \n\n' && exit 0 || exit 1

#Unmount the device.

#13  umount /testsuites/usb_ehci/scripts/misc/mass_storage
13  set -x; umount  $MASS_DIRECTORY && echo -e '\n\n\t Device unmounted  \n\n' && exit 0 || exit 1

#Mount the partition and test it by writing/reading a file

#14  mount  /dev/sda1 /testsuites/usb_ehci/scripts/misc/mass_storage
14  set -x; mount  /dev/sda1 $MASS_DIRECTORY  && echo -e '\n\n\t USB mass storage device mounted properly \n\n'  && exit 0 || exit 1

#15  cmp /testsuites/usb_ehci/scripts/misc/6m /testsuites/usb_ehci/scripts/misc/mass_storage
15  set -x; cmp  ${MISC_PATH}/$MASS_FILE $MASS_DIRECTORY/$MASS_FILE && echo -e '\n\n\t Compare test succeeded  \n\n' &&  exit 0 || exit 1

#Unmount the device.

#16  umount /testsuites/usb_ehci/scripts/misc/mass_storage
16  set -x; umount  $MASS_DIRECTORY && echo -e '\n\n\t Device unmounted  \n\n' && exit 0 || exit 1

#17  cat  /proc/bus/usb/devices | grep 'stor'
17  set -x; echo -e '\n\n\t Disconnect USB Mass Storage Device from USB port \n\n' && sleep $DELAY3 &&  cat $ENUM_COMM | grep 'stor '&& exit 1 || exit 0

##Checking if file exists after disconnect usb storage device
18  set -x; echo -e '\n\n\t Connect USB Mass Storage Device to USB port \n\n' && sleep $DELAY3  && exit 0 || exit 1
19  set -x; if [ $USB_DRIVER = "MENTOR" ] ; then  echo 'F' > $PROC_INT && sleep $DELAY2 ; fi  && cat $ENUM_COMM | grep 'stor' && exit 0 || exit 1
20  set -x; mknod /dev/sda b 8 0 && mknod /dev/sda1 b 8 1 && exit 0 || exit 0
21  set -x; mount  /dev/sda1 $MASS_DIRECTORY  && echo -e '\n\n\t USB mass storage device mounted properly \n' && exit 0 || exit 1
22  set -x; cmp  ${MISC_PATH}/$MASS_FILE $MASS_DIRECTORY/$MASS_FILE && echo -e '\n\n\t Compare test succeeded  \n\n' && exit 0 || exit 1
23  set -x; rm $MASS_DIRECTORY/$MASS_FILE  && exit 0 || exit 1

#Unmount the device.
24  set -x; umount  $MASS_DIRECTORY && echo -e '\n\n\t Device unmounted  \n\n' && exit 0 || exit 1

25  echo -e '\n\n\t Disconnect USB Mass Storage Device from USB port \n\n' && sleep $DELAY3 &&  cat $ENUM_COMM | grep 'stor '&& exit 1 || exit 0
26  set -x; rmmod usb-storage && rmmod sd_mod && rmmod scsi_mod && exit 0 || exit 1

#27 set -x; if [ $USB_DRIVER = "MENTOR" ] ; then    rmmod g_zero.ko ; fi && exit 0 || exit 1

bar	echo L_DD_USBEHCI_0005_1
